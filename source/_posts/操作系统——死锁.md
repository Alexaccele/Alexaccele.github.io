---
title: 操作系统——死锁
date: 2018/11/06 17:28:03
tags: [操作系统,死锁]
categories: 操作系统
---
# 死锁
在一组进程发生死锁的情况下,这组死锁进程中的每一个进程,都在等待另一个死锁
进程所占有的资源。 或者说每个进程所等待的事件是该组中其它进程释放所占有的资源。
但由于所有这些进程已都无法运行,因此它们谁也不能释放资源,致使没有任何一个进程
可被唤醒。 这样这组进程只能无限期地等待下去。 由此可以给死锁做出如下的定义:

> 如果一组进程中的每一个进程都在等待仅由该组进程中的其它进程才能引发的事件,
> 那么该组进程是死锁的(Deadlock).

## 产生死锁的必要条件

1. 互斥条件：进程要求对所分配的资源进行排它性控制，即在一段时间内某资源仅为一进程所占用。
1. 请求和保持条件：当进程因请求资源而阻塞时，对已获得的资源保持不放。
1. 不剥夺条件：进程已获得的资源在未使用完之前，不能剥夺，只能在使用完时由自己释放。
1. 环路等待条件：在发生死锁时，必然存在一个进程--资源的环形链。
<!--more-->
## 处理死锁的方法

### 1. 预防死锁
#### 破坏“请求与保持”条件
在采用这种方法时，系统规定所有进程在开始运行之前，都必须一次性的申请其在整个运行过程所需的全部资源。此时，若系统有足够的资源分配给某进程，便可把其需要的所有资源分配给进程，这样，该进程在整个运行期间便不会再提出资源要求，从而破坏了请求条件。但在分配资源时，只要有一种资源不能满足某进程的要求，即使其它所需各资源都空闲，也不分配给该进程，而让该进程等待。由于在该进程的等待期间，它并未占用任何资源，因而也破坏了保持条件，从而避免发生死锁。

缺点：首先表现为资源被严重浪费，因为一个进程是一次性地获得其整个运行过程中所需的全部资源的，且独占资源，其中可能有些资源很少用，甚至在整个运行期间都未使用，这就严重的恶化了系统资源的利用率；其次是使进程延迟运行，仅当进程在获得了其所需的全部资源后，才能开始运行，但可能因有些资源已长期被其它进程占用而使等待该资源的进程迟迟不能运行。

#### 破坏“不剥夺”条件
在采用这种方法时系统规定，进程是逐个地提出对资源的要求的。当一个已经保持了某些资源的进程，再提出新的资源请求而不能立即满足时，必须释放它已经保持了的所有资源，待以后需要时再重新申请。这意味着某一进程已经占有的资源，在运行过程中会被占时释放掉，也可认为是被剥夺了，从而破坏了“不剥夺”条件。
#### 破坏“环路等待”条件
这种方法中规定，系统将所有资源按类型进行线性排队，并赋予不同的序号。例如，令输入机的序号为1，打印机的序号为2，磁带机为3，磁盘为4.所有进程对资源的请求必须严格按照资源序号递增的次序提出，这样，在所形成的资源分配图中，不可能再出现环路，因而破坏了“环路等待”条件。

### 2. 避免死锁
利用银行家算法避免死锁：每一个新进程在进入系统时，必须申明在运行过程中，可能需要每种资源类型的最大单元数目，其数目不应超过系统所拥有的资源总量。当进程请求一组资源时，系统必须首先确定是否有足够的资源分配给该进程。若有，再进一步计算在将这些资源分配给进程后，是否会使系统处于不安全状态。如果不会，才将资源分配给进程，否则让进程等待。

### 3. 检测死锁
资源分配图（Resource Allocation Graph）

![](https://i.imgur.com/EmAOhkH.png)

如上图， 用圆圈代表一个进程，用框代表一类资源。由于一种类型的资源可能有多个，用框中的一个点代表一类资源中的一个资源。从进程到资源的有向边叫请求边，表示该进程申请一个单位的该类资源；从资源到进程的边叫分配边，表示该类资源已经有一个资源被分配给了该进程。

死锁定理：
可以通过将资源分配图简化的方法来检测系统状态  S  是否为死锁状态。简化方法如下：

（1）、在资源分配图中，找到既不阻塞又不是孤点的进程 Pi （即找出一条有向边与它相连，且该有向边对应资源的申请数量小于等于系统中已有空闲资源数量）。消去它所有的请求边和分配边，使之成为孤立的结点。在这里要注意一个问题，判断某种资源是否有空闲，应该用它的资源数量减去它在资源分配图中的出度。

（2）、进程 Pi 所释放的资源，可以唤醒某些因等待这些资源而阻塞的进程，原来的阻塞进程可以变为非阻塞进程。根据（1）中的方法进行一系列简化后，若能消去图中所有的边，则称该图是可完全简化的。
S为死锁的条件是：当且仅当 S 状态的资源分配图是不可完全简化的，该条件为死锁定理。
### 4. 解除死锁

一旦检测出死锁，就应立即采取相应的措施，以解除死锁。死锁解除的主要方法有：

（1）、资源剥夺法。挂起某些死锁进程，并抢占它的资源，将这些资源分配给其他的死锁进程。但应防止被挂起的进程长时间得不到资源，而处于资源匮乏的状态。

（2）、撤销进程法。强制撤销部分、甚至全部死锁进程并剥夺这些进程的资源。撤销的原则可以按进程优先级和撤销进程代价的高低进行。

（3）、进程回退法。让一（或多）个进程回退足以回避死锁的地步，进程回退时自愿释放资源而不是被剥夺。要求系统保持进程的历史信息，设置还原点。

